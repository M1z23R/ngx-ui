<div
  class="ui-select-wrapper"
  [class.ui-select-wrapper--error]="error()"
  [class.ui-select-wrapper--disabled]="disabled()"
  [class.ui-select-wrapper--open]="isOpen()"
>
  @if (label()) {
    <label class="ui-select__label">
      {{ label() }}
    </label>
  }

  <div
    #triggerRef
    class="ui-select__trigger"
    [class]="triggerClasses()"
    [attr.role]="'combobox'"
    [attr.aria-expanded]="isOpen()"
    [attr.aria-haspopup]="'listbox'"
    [attr.aria-disabled]="disabled()"
    [attr.tabindex]="searchable() ? -1 : (disabled() ? -1 : 0)"
    (click)="toggle()"
    (keydown)="handleTriggerKeydown($event)"
  >
    @if (searchable()) {
      <input
        #searchInput
        type="text"
        class="ui-select__input"
        [placeholder]="inputPlaceholder()"
        [value]="isOpen() ? searchQuery() : (selectable() ? displayValue() : '')"
        [disabled]="disabled()"
        (input)="onSearchInput($any($event.target).value)"
        (keydown)="handleSearchInputKeydown($event)"
        (focus)="toggle()"
        autocomplete="off"
      />
    } @else {
      <span class="ui-select__value">
        @if (displayValue()) {
          {{ displayValue() }}
        } @else {
          <span class="ui-select__placeholder">{{ placeholder() }}</span>
        }
      </span>
    }

    <div class="ui-select__icons">
      @if (clearable() && hasValue() && !disabled()) {
        <button
          type="button"
          class="ui-select__clear"
          (click)="clear($event)"
          aria-label="Clear selection"
        >
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18"></line>
            <line x1="6" y1="6" x2="18" y2="18"></line>
          </svg>
        </button>
      }
      <svg
        class="ui-select__arrow"
        [class.ui-select__arrow--open]="isOpen()"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
      >
        <polyline points="6 9 12 15 18 9"></polyline>
      </svg>
    </div>
  </div>

  <div
    #dropdownRef
    class="ui-select__dropdown"
    [class.ui-select__dropdown--open]="isOpen()"
    [attr.role]="'listbox'"
    [attr.aria-multiselectable]="multiple()"
  >
    <div class="ui-select__options">
      @if (isAsyncMode()) {
        <!-- Async mode: render options from asyncSearch results -->
        @if (asyncLoading()) {
          <div class="ui-select__loading">
            <svg class="ui-select__spinner" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" stroke-opacity="0.25"></circle>
              <path d="M12 2a10 10 0 0 1 10 10" stroke-linecap="round"></path>
            </svg>
            <span>Searching...</span>
          </div>
        } @else if (asyncError()) {
          <div class="ui-select__error-message">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span>{{ asyncError() }}</span>
          </div>
        } @else {
          @for (option of visibleAsyncOptions(); track option.value; let i = $index) {
            <div
              class="ui-async-option"
              [class.ui-async-option--selected]="isAsyncOptionSelected(option)"
              [class.ui-async-option--disabled]="option.disabled"
              [class.ui-async-option--focused]="focusedIndex() === i"
              [attr.role]="'option'"
              [attr.aria-selected]="isAsyncOptionSelected(option)"
              [attr.aria-disabled]="option.disabled"
              (click)="selectAsyncOption(option, $event)"
            >
              @if (multiple() && isAsyncOptionSelected(option)) {
                <svg class="ui-async-option__check" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
              }
              <span class="ui-async-option__content">
                @if (optionTemplate(); as tpl) {
                  <ng-container *ngTemplateOutlet="tpl.templateRef; context: { $implicit: option.value, option: option.value, selected: isAsyncOptionSelected(option), disabled: !!option.disabled }"></ng-container>
                } @else {
                  {{ option.label }}
                }
              </span>
            </div>
          }
          @if (visibleAsyncOptions().length === 0 && searchQuery().trim().length >= minSearchLength()) {
            <div class="ui-select__empty">No results found</div>
          }
          @if (searchQuery().trim().length < minSearchLength() && minSearchLength() > 0) {
            <div class="ui-select__empty">Type at least {{ minSearchLength() }} characters to search</div>
          }
        }
      } @else {
        <!-- Static mode: render content children -->
        <ng-content />
        @if (visibleOptions().length === 0 && !(creatable() && searchQuery().trim())) {
          <div class="ui-select__empty">No options found</div>
        }
      }
    </div>
    @if (creatable() && searchQuery().trim() && !exactMatchExists()) {
      <div
        class="ui-select__create"
        (click)="handleCreate()"
      >
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <line x1="12" y1="5" x2="12" y2="19"></line>
          <line x1="5" y1="12" x2="19" y2="12"></line>
        </svg>
        Create "{{ searchQuery().trim() }}"
      </div>
    }
  </div>

  @if (error()) {
    <span class="ui-select__error">{{ error() }}</span>
  }
  @if (hint() && !error()) {
    <span class="ui-select__hint">{{ hint() }}</span>
  }
</div>
